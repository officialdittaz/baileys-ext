name: Auto Release and Publish to npm

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  check-release:
    name: Check for version change
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check_version.outputs.version_changed }}
      version: ${{ steps.check_version.outputs.version }}
      previous_version: ${{ steps.check_version.outputs.previous_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version vs latest tag
        id: check_version
        run: |
          NEW_VERSION=$(jq -r .version package.json)
          echo "New version: $NEW_VERSION"

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          OLD_VERSION=${LAST_TAG#v}
          echo "Last tag: $LAST_TAG"
          echo "Old version: $OLD_VERSION"

          if [ "$NEW_VERSION" != "$OLD_VERSION" ]; then
            echo "Version changed: $OLD_VERSION to $NEW_VERSION"
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "previous_version=$OLD_VERSION" >> $GITHUB_OUTPUT
          else
            echo "No version change detected"
            echo "version_changed=false" >> $GITHUB_OUTPUT
          fi

  create-release:
    name: Create GitHub Release
    needs: check-release
    runs-on: ubuntu-latest
    if: needs.check-release.outputs.version_changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit count and contributors
        id: stats
        run: |
          PREV_TAG="v${{ needs.check-release.outputs.previous_version }}"
          
          if git rev-parse "$PREV_TAG" >/dev/null 2>&1; then
            COMMIT_COUNT=$(git rev-list --count ${PREV_TAG}..HEAD)
            CONTRIBUTORS=$(git log ${PREV_TAG}..HEAD --format='%aN' | sort -u | wc -l)
          else
            COMMIT_COUNT=$(git rev-list --count HEAD)
            CONTRIBUTORS=$(git log --format='%aN' | sort -u | wc -l)
          fi
          
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT

      - name: Get package info
        id: package
        run: |
          PACKAGE_NAME=$(jq -r .name package.json)
          DESCRIPTION=$(jq -r .description package.json)
          LICENSE=$(jq -r .license package.json)
          
          echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "license=$LICENSE" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-release.outputs.version }}
          name: Release v${{ needs.check-release.outputs.version }}
          body: |
            # Release v${{ needs.check-release.outputs.version }}
            
            ${{ steps.package.outputs.description }}
            
            ---
            
            ## Release Information
            
            | Property | Value |
            |----------|-------|
            | Version | `${{ needs.check-release.outputs.version }}` |
            | Previous Version | `${{ needs.check-release.outputs.previous_version }}` |
            | Release Date | `${{ github.event.head_commit.timestamp }}` |
            | Commits | ${{ steps.stats.outputs.commit_count }} |
            | Contributors | ${{ steps.stats.outputs.contributors }} |
            | License | `${{ steps.package.outputs.license }}` |
            
            ---
            
            ## Changes
            
            This release includes **${{ steps.stats.outputs.commit_count }} commits** from **${{ steps.stats.outputs.contributors }} contributor(s)**.
            
            ### View Changes
            
            - **Compare with previous version:**  
              [v${{ needs.check-release.outputs.previous_version }}...v${{ needs.check-release.outputs.version }}](https://github.com/${{ github.repository }}/compare/v${{ needs.check-release.outputs.previous_version }}...v${{ needs.check-release.outputs.version }})
            
            - **View commit history:**  
              [All commits in this release](https://github.com/${{ github.repository }}/commits/v${{ needs.check-release.outputs.version }})
            
            ---
            
            ## Installation
            
            ### Requirements
            
            This package requires **Bun runtime** due to the use of Bun-specific APIs.
            
            ### Install Package
            
            ```bash
            bun add ${{ steps.package.outputs.name }}@${{ needs.check-release.outputs.version }}
            ```
            
            Or install the latest version:
            
            ```bash
            bun add ${{ steps.package.outputs.name }}
            ```
            
            ---
            
            ## Package Links
            
            - **npm Registry:** https://www.npmjs.com/package/${{ steps.package.outputs.name }}
            - **GitHub Repository:** https://github.com/${{ github.repository }}
            - **Issue Tracker:** https://github.com/${{ github.repository }}/issues
            - **Documentation:** https://github.com/${{ github.repository }}#readme
            
            ---
            
            ## Assets
            
            Source code archives (`.zip` and `.tar.gz`) are automatically attached to this release.
            
            ---
            
            For bug reports and feature requests, please visit our [issue tracker](https://github.com/${{ github.repository }}/issues).
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

  publish-npm:
    name: Publish to npm
    needs: [check-release, create-release]
    runs-on: ubuntu-latest
    if: needs.check-release.outputs.version_changed == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Verify version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          EXPECTED_VERSION="${{ needs.check-release.outputs.version }}"
          
          if [ "$PACKAGE_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "Error: Version mismatch!"
            echo "Package.json: $PACKAGE_VERSION"
            echo "Expected: $EXPECTED_VERSION"
            exit 1
          fi
          
          echo "Version verified: v$PACKAGE_VERSION"

      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          bun install --frozen-lockfile

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "Error: NPM_TOKEN secret is not set"
            exit 1
          fi
          
          echo "Publishing to npm..."
          npm publish --access public
          
          echo "Successfully published v${{ needs.check-release.outputs.version }} to npm"