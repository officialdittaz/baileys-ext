name: CI with Bun

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ci:
    name: CI with Bun
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Verify Bun installation
        run: |
          bun --version
          echo "âœ“ Bun installed successfully"

      - name: Install dependencies
        run: bun install

      - name: Run preinstall check
        run: bun run node ./engine-requirements.js

      - name: Run ESLint
        run: bunx eslint .
        continue-on-error: true

      - name: Run Prettier check
        id: prettier-check
        run: |
          if bunx prettier --check . --ignore-path .prettierignore; then
            echo "prettier_needed=false" >> $GITHUB_OUTPUT
          else
            echo "prettier_needed=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check version changes
        id: version
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            if git diff HEAD^ HEAD -- package.json | grep -q '"version"'; then
              echo "version_changed=true" >> $GITHUB_OUTPUT
            else
              echo "version_changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for skip-ci marker
        id: skip-ci
        run: |
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$LAST_COMMIT_MSG" == *"[skip-prettier]"* ]] || [[ "$LAST_COMMIT_MSG" == *"style: auto-format"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Prettier auto-format
        id: format
        if: |
          steps.version.outputs.version_changed == 'true' && 
          steps.prettier-check.outputs.prettier_needed == 'true' &&
          steps.skip-ci.outputs.skip == 'false' &&
          github.event_name == 'push' &&
          github.ref == 'refs/heads/main'
        run: |
          bunx prettier --write . --ignore-path .prettierignore
          if git diff --quiet; then
            echo "changes_made=false" >> $GITHUB_OUTPUT
          else
            echo "changes_made=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit & Push changes
        if: steps.format.outputs.changes_made == 'true'
        run: |
          git config --global user.name "naruyaizumi"
          git config --global user.email "sexystyle088@gmail.com"
          git add .
          git commit -m "style: auto-format with Prettier [skip-prettier]"
          
          max_retries=3
          retry_count=0
          until git push origin main || [ $retry_count -eq $max_retries ]; do
            retry_count=$((retry_count + 1))
            echo "Push failed, retrying ($retry_count/$max_retries)..."
            git pull --rebase origin main
            sleep 2
          done
          
          if [ $retry_count -eq $max_retries ]; then
            echo "Failed to push after $max_retries attempts"
            exit 1
          fi

      - name: Verify formatting
        run: |
          if git diff --quiet; then
            echo "âœ“ No formatting changes needed"
          else
            echo "âš  Warning: Unexpected formatting differences detected"
            git diff --stat
          fi

      - name: CI Summary
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bun installation: Success" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependencies: Installed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Preinstall check: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ ESLint: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’… Prettier: ${{ steps.prettier-check.outputs.prettier_needed == 'true' && 'Formatted' || 'Already clean' }}" >> $GITHUB_STEP_SUMMARY